!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("react")):"function"==typeof define&&define.amd?define(["exports","react"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).wurd={},t.React)}(this,function(t,e){"use strict";function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var f=n(e);function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach(function(t){s(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function a(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function s(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function p(t,e){if(null==t)return{};var n,r,o=function(t,e){if(null==t)return{};var n,r,o={},i=Object.keys(t);for(r=0;r<i.length;r++)n=i[r],0<=e.indexOf(n)||(o[n]=t[n]);return o}(t,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(r=0;r<i.length;r++)n=i[r],0<=e.indexOf(n)||Object.prototype.propertyIsEnumerable.call(t,n)&&(o[n]=t[n])}return o}var c=function(){function r(){var t,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};i(this,r),this.rawContent=e,this.storageKey=n.storageKey||"wurdContent",this.ttl=null!==(t=n.ttl)&&void 0!==t?t:36e5}return a(r,[{key:"get",value:function(t){return t?t.split(".").reduce(function(t,e){return t&&t[e]},this.rawContent):this.rawContent}},{key:"load",value:function(t,e){var n=(1<arguments.length&&void 0!==e?e:{}).lang,r=this.rawContent,o=this.storageKey,i=this.ttl;try{var a=JSON.parse(localStorage.getItem(o)),c=a&&a._wurd;return!a||!c||c.savedAt+i<Date.now()?r:(c.lang!==n||(delete a._wurd,Object.assign(r,a)),r)}catch(t){return console.error("Wurd: error loading cache:",t),r}}},{key:"save",value:function(t,e){var n=(1<arguments.length&&void 0!==e?e:{}).lang,r=this.rawContent,o=this.storageKey;Object.assign(r,t),localStorage.setItem(o,JSON.stringify(h(h({},r),{},{_wurd:{savedAt:Date.now(),lang:n}})))}},{key:"clear",value:function(){localStorage.removeItem(this.storageKey)}}]),r}(),u=function(){function o(t,e){var n=this;i(this,o),this.wurd=t,this.path=e,this._get=t.store.get.bind(t.store),Object.getOwnPropertyNames(Object.getPrototypeOf(this)).forEach(function(t){n[t]=n[t].bind(n)})}return a(o,[{key:"id",value:function(t){return t?this.path?[this.path,t].join("."):t:this.path}},{key:"get",value:function(t){var e=this._get(this.id(t));if(void 0===e&&this.wurd.draft){var n=t.split(".")[0];this._get(n)||console.warn("Tried to access unloaded section: ".concat(n))}return e}},{key:"text",value:function(t,e){var n=this.get(t);return void 0===n?this.wurd.draft?"[".concat(t,"]"):"":"string"!=typeof n?(console.warn("Tried to get object as string: ".concat(t)),this.wurd.draft?"[".concat(t,"]"):""):(e&&(n=function(t,e){var n=1<arguments.length&&void 0!==e?e:{};return"string"!=typeof t?t:t.replace(/{{([\w.-]+)}}/g,function(t,e){return n[e]||""})}(n,e)),n)}},{key:"markdown",value:function(t,e,n){var r=this.wurd.markdown,o=r.parse,i=r.parseInline,a=this.text(t,e);return null!=n&&n.inline&&i?i(a):o?o(a):a}},{key:"map",value:function(o,i){var a=this,t=this.get(o)||s({},Date.now(),{}),c=0;return Object.keys(t).sort().map(function(t){var e=c;c++;var n=[o,t].join("."),r=a.block(n);return i.call(void 0,r,e)})}},{key:"block",value:function(t,e){var n=this.id(t),r=new o(this.wurd,n);return"function"==typeof e?e.call(void 0,r):r}},{key:"el",value:function(t,e,n){var r=2<arguments.length&&void 0!==n?n:{},o=this.id(t),i=r.markdown?this.markdown(t,e):this.text(t,e),a=e||r.markdown?"data-wurd-md":"data-wurd";if(this.wurd.draft){var c=r.type||"span";return r.markdown&&(c="div"),"<".concat(c," ").concat(a,'="').concat(o,'">').concat(i,"</").concat(c,">")}return i}}]),o}(),d="https://widget.wurd.io/widget.js",l=function(){function r(t){var e=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};i(this,r),this.store=new c,this.content=new u(this,null),Object.getOwnPropertyNames(Object.getPrototypeOf(this.content)).forEach(function(t){e[t]=e.content[t].bind(e.content)}),this.connect(t,n)}return a(r,[{key:"connect",value:function(t,e){var n=this,r=1<arguments.length&&void 0!==e?e:{};switch(this.app=t,this.draft=!1,this.editMode=!1,["draft","lang","markdown","debug"].forEach(function(t){var e=r[t];void 0!==e&&(n[t]=e)}),r.editMode){case!0:this.startEditor();break;case"querystring":/[?&]edit(&|$)/.test(location.search)&&this.startEditor()}return r.rawContent&&this.store.save(r.rawContent,{lang:r.lang}),r.storageKey&&(this.store.storageKey=r.storageKey),r.ttl&&(this.store.ttl=r.ttl),r.blockHelpers&&this.setBlockHelpers(r.blockHelpers),this}},{key:"load",value:function(t){var e=this,n=this.app,r=this.store,o=this.lang,i=this.editMode,a=this.debug;if(!n)return Promise.reject(new Error("Use wurd.connect(appName) before wurd.load()"));var c="string"==typeof t?t.split(","):t;if(i)return this._fetchSections(c).then(function(t){return r.save(t,{lang:o}),r.clear(),e.content});var s=r.load(c,{lang:o}),u=c.filter(function(t){return void 0===s[t]});return a&&console.info("Wurd: from cache:",c.filter(function(t){return void 0!==s[t]})),0===u.length?Promise.resolve(this.content):this._fetchSections(u).then(function(t){return r.save(t,{lang:o}),e.content})}},{key:"_fetchSections",value:function(e){var n=this,t=this.app;this.debug&&console.info("Wurd: from server:",e);var r,o=["draft","lang"].reduce(function(t,e){return n[e]&&(t[e]=n[e]),t},{}),i="".concat("https://api.wurd.io","/apps/").concat(t,"/content/").concat(e,"?").concat((r=o,Object.keys(r).map(function(t){var e=r[t];return encodeURIComponent(t)+"="+encodeURIComponent(e)}).join("&")));return this._fetch(i).then(function(t){if(t.error)throw t.error.message?new Error(t.error.message):new Error("Error loading ".concat(e));return t})}},{key:"_fetch",value:function(e){return fetch(e).then(function(t){if(!t.ok)throw new Error("Error loading ".concat(e,": ").concat(t.statusText));return t.json()})}},{key:"startEditor",value:function(){var t=this.app,e=this.lang;this.editMode=!0,this.draft=!0;var n=document.createElement("script");n.src=d,n.async=!0,n.setAttribute("data-app",t),e&&n.setAttribute("data-lang",e);var r=document.body.querySelector('script[src="'.concat(d,'"]'));r&&document.body.removeChild(r),document.body.appendChild(n)}},{key:"setBlockHelpers",value:function(t){Object.assign(u.prototype,t)}}]),r}(),v=new l;v.Wurd=l;var y=["block","id","sid","type","component","vars"];function g(t){var e=t.block,n=t.id,r=t.sid,o=t.type,i=void 0===o?"span":o,a=t.component,c=void 0===a?i:a,s=t.vars,u=p(t,y),d=(e=e||v.content).text(n,s),l=h({},u);v.editMode&&(l[s?"data-wurd-md":"data-wurd"]=e.id(r||n));return f.default.createElement(c,l,d)}var b=["block","id","sid","type","component","vars"];function w(t){var e=t.block,n=t.id,r=t.sid,o=t.type,i=void 0===o?"div":o,a=t.component,c=void 0===a?i:a,s=t.vars,u=p(t,b),d=(e=e||v.content).markdown(n,s),l=h(h({},u),{},{dangerouslySetInnerHTML:{__html:d}});return v.editMode&&(l["data-wurd-md"]=e.id(r||n)),f.default.createElement(c,l)}var m=["block","id","sid"];function k(t){var e=t.block,n=t.id,r=t.sid,o=p(t,m),i=(e=e||v.content).text(n),a=h(h({},o),{},{src:i});return v.editMode&&(a["data-wurd-img"]=e.id(r||n)),f.default.createElement("img",a)}var O=["block","id","children","type","component","keys"];function j(t){var e=t.block,n=t.id,r=t.children,o=t.type,i=void 0===o?"ul":o,a=t.component,c=void 0===a?i:a,s=t.keys,u=void 0===s?"title":s,d=p(t,O);e=e||v.content;var l=h({},d);return v.editMode&&(l["data-wurd-list"]=e.id(n),l["data-wurd-list-props"]=u),f.default.createElement(c,l,e.map(n,function(t,e){return r(t,e)}))}var E=["block","id","sid","keys","type","component","children"];function P(t){var e=t.block,n=t.id,r=t.sid,o=t.keys,i=t.type,a=void 0===i?"span":i,c=t.component,s=void 0===c?a:c,u=t.children,d=p(t,E);e=e||v.content;var l=h({},d);return v.editMode&&(l["data-wurd-obj"]=e.id(r||n),l["data-wurd-obj-props"]=Array.isArray(o)?o.join(","):o),f.default.createElement(s,l,u)}v.setBlockHelpers({Text:function(t){return f.default.createElement(g,h({block:this},t))},Markdown:function(t){return f.default.createElement(w,h({block:this},t))},Image:function(t){return f.default.createElement(k,h({block:this},t))},List:function(t){return f.default.createElement(j,h({block:this},t))},Object:function(t){return f.default.createElement(P,h({block:this},t))}}),t.WurdImage=k,t.WurdList=j,t.WurdMarkdown=w,t.WurdObject=P,t.WurdText=g,t.default=v,Object.defineProperty(t,"__esModule",{value:!0})});
