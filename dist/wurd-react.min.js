!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("react")):"function"==typeof define&&define.amd?define(["exports","react"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).wurd={},t.React)}(this,function(t,e){"use strict";function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var c=n(e);function r(e,t){var n,r=Object.keys(e);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(e),t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)),r}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach(function(t){d(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function a(t,e,n){e&&i(t.prototype,e),n&&i(t,n),Object.defineProperty(t,"prototype",{writable:!1})}function d(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function u(t,e){if(null==t)return{};var n,r=function(t,e){if(null==t)return{};for(var n,r={},o=Object.keys(t),i=0;i<o.length;i++)n=o[i],0<=e.indexOf(n)||(r[n]=t[n]);return r}(t,e);if(Object.getOwnPropertySymbols)for(var o=Object.getOwnPropertySymbols(t),i=0;i<o.length;i++)n=o[i],0<=e.indexOf(n)||Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n]);return r}var l=function(){function n(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};o(this,n),this.rawContent=t,this.storageKey=e.storageKey||"wurdContent",this.ttl=null!=(t=e.ttl)?t:36e5}return a(n,[{key:"get",value:function(t){return t?t.split(".").reduce(function(t,e){return t&&t[e]},this.rawContent):this.rawContent}},{key:"load",value:function(t){var e=(1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).lang,n=this.rawContent,r=this.storageKey,o=this.ttl;try{var i=JSON.parse(localStorage.getItem(r)),a=i&&i._wurd;return!i||!a||a.savedAt+o<Date.now()||a.lang===e&&(delete i._wurd,Object.assign(n,i)),n}catch(t){return console.error("Wurd: error loading cache:",t),n}}},{key:"save",value:function(t){var e=(1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).lang,n=this.rawContent,r=this.storageKey;Object.assign(n,t),localStorage.setItem(r,JSON.stringify(s(s({},n),{},{_wurd:{savedAt:Date.now(),lang:e}})))}},{key:"clear",value:function(){localStorage.removeItem(this.storageKey)}}]),n}(),f=function(){function r(t,e){var n=this;o(this,r),this.wurd=t,this.path=e,this._get=t.store.get.bind(t.store),Object.getOwnPropertyNames(Object.getPrototypeOf(this)).forEach(function(t){n[t]=n[t].bind(n)})}return a(r,[{key:"id",value:function(t){return t?this.path?[this.path,t].join("."):t:this.path}},{key:"get",value:function(t){var e=this._get(this.id(t));return void 0===e&&this.wurd.draft&&(t=t.split(".")[0],this._get(t)||console.warn("Tried to access unloaded section: ".concat(t))),e}},{key:"text",value:function(t,e){var n;return void 0===(n=this.get(t))?this.wurd.draft?"[".concat(t,"]"):"":"string"!=typeof n?(console.warn("Tried to get object as string: ".concat(t)),this.wurd.draft?"[".concat(t,"]"):""):e?function(t,e){var n=1<arguments.length&&void 0!==e?e:{};return"string"!=typeof t?t:t.replace(/{{([\w.-]+)}}/g,function(t,e){return n[e]||""})}(n,e):n}},{key:"markdown",value:function(t,e,n){var r=this.wurd.markdown,o=r.parse,r=r.parseInline,t=this.text(t,e);return null!=n&&n.inline&&r?r(t):o?o(t):t}},{key:"map",value:function(n,r){var o=this,t=this.get(n)||d({},Date.now(),{}),i=0;return Object.keys(t).sort().map(function(t){var e=i,t=(i++,[n,t].join(".")),t=o.block(t);return r.call(void 0,t,e)})}},{key:"block",value:function(t,e){t=this.id(t),t=new r(this.wurd,t);return"function"==typeof e?e.call(void 0,t):t}},{key:"el",value:function(t,e){var n,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},o=this.id(t),t=r.markdown?this.markdown(t,e):this.text(t,e),e=e||r.markdown?"data-wurd-md":"data-wurd";return this.wurd.draft?(n=r.type||"span",r.markdown&&(n="div"),"<".concat(n," ").concat(e,'="').concat(o,'">').concat(t,"</").concat(n,">")):t}}]),r}(),e=function(){function r(t){var e=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};o(this,r),this.widgetUrl="https://widget.wurd.io/widget.js",this.apiUrl="https://api.wurd.io",this.store=new l,this.content=new f(this,null),Object.getOwnPropertyNames(Object.getPrototypeOf(this.content)).forEach(function(t){e[t]=e.content[t].bind(e.content)}),this.connect(t,n)}return a(r,[{key:"connect",value:function(t){var n=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};switch(this.app=t,this.draft=!1,this.editMode=!1,["draft","lang","markdown","debug","onLoad"].forEach(function(t){var e=r[t];void 0!==e&&(n[t]=e)}),r.editMode){case!0:this.startEditor();break;case"querystring":/[?&]edit(&|$)/.test(location.search)&&this.startEditor()}return r.rawContent&&this.store.save(r.rawContent,{lang:r.lang}),r.storageKey&&(this.store.storageKey=r.storageKey),r.ttl&&(this.store.ttl=r.ttl),r.blockHelpers&&this.setBlockHelpers(r.blockHelpers),this}},{key:"load",value:function(t){var e,n=this.app,r=this.store,o=this.lang,i=this.editMode,a=this.debug,c=this.onLoad,s=this.content;return n?(n="string"==typeof t?t.split(","):t,i?this._fetchSections(n).then(function(t){return r.save(t,{lang:o}),r.clear(),c&&c(s),s}):(e=r.load(n,{lang:o}),t=n.filter(function(t){return void 0===e[t]}),a&&console.info("Wurd: from cache:",n.filter(function(t){return void 0!==e[t]})),0===t.length?(c&&c(s),Promise.resolve(s)):this._fetchSections(t).then(function(t){return r.save(t,{lang:o}),c&&c(s),s}))):Promise.reject(new Error("Use wurd.connect(appName) before wurd.load()"))}},{key:"_fetchSections",value:function(e){var n,r=this,t=this.app,o=(this.debug&&console.info("Wurd: from server:",e),["draft","lang"].reduce(function(t,e){return r[e]&&(t[e]=r[e]),t},{})),t="".concat(this.apiUrl,"/apps/").concat(t,"/content/").concat(e,"?").concat((n=o,Object.keys(n).map(function(t){var e=n[t];return encodeURIComponent(t)+"="+encodeURIComponent(e)}).join("&")));return this._fetch(t).then(function(t){if(t.error)throw t.error.message?new Error(t.error.message):new Error("Error loading ".concat(e));return t})}},{key:"_fetch",value:function(e){return fetch(e).then(function(t){if(t.ok)return t.json();throw new Error("Error loading ".concat(e,": ").concat(t.statusText))})}},{key:"startEditor",value:function(){var t=this.app,e=this.lang,n=(this.editMode=!0,this.draft=!0,document.createElement("script")),t=(n.src=this.widgetUrl,n.async=!0,n.setAttribute("data-app",t),e&&n.setAttribute("data-lang",e),document.body.querySelector('script[src="'.concat(this.widgetUrl,'"]')));t&&document.body.removeChild(t),document.body.appendChild(n)}},{key:"setBlockHelpers",value:function(t){Object.assign(f.prototype,t)}}]),r}(),h=new e,p=(h.Wurd=e,["block","id","sid","type","component","vars"]);function v(t){var e=t.block,n=t.id,r=t.sid,o=t.type,i=t.component,o=void 0===i?void 0===o?"span":o:i,i=t.vars,t=u(t,p),a=(e=e||h.content).text(n,i),t=s({},t);return h.editMode&&(t[i?"data-wurd-md":"data-wurd"]=e.id(r||n)),c.default.createElement(o,t,a)}var g=["block","id","sid","type","component","vars","inline"];function y(t){var e=t.block,n=t.id,r=t.sid,o=t.type,i=t.component,o=void 0===i?void 0===o?"div":o:i,i=t.vars,a=t.inline,t=u(t,g),i=(e=e||h.content).markdown(n,i,{inline:a}),a=s(s({},t),{},{dangerouslySetInnerHTML:{__html:i}});return h.editMode&&(a["data-wurd-md"]=e.id(r||n)),c.default.createElement(o,a)}var b=["block","id","sid"];function w(t){var e=t.block,n=t.id,r=t.sid,t=u(t,b),o=(e=e||h.content).text(n),t=s(s({},t),{},{src:o});return h.editMode&&(t["data-wurd-img"]=e.id(r||n)),c.default.createElement("img",t)}var m=["block","id","children","type","component","keys"];function k(t){var e=t.block,n=t.id,r=t.children,o=t.type,i=t.component,o=void 0===i?void 0===o?"ul":o:i,i=t.keys,i=void 0===i?"title":i,t=u(t,m),e=e||h.content,t=s({},t);return h.editMode&&(t["data-wurd-list"]=e.id(n),t["data-wurd-list-props"]=i),c.default.createElement(o,t,e.map(n,function(t,e){return r(t,e)}))}var O=["block","id","sid","keys","type","component","children"];function j(t){var e=t.block,n=t.id,r=t.sid,o=t.keys,i=t.type,a=t.component,i=void 0===a?void 0===i?"span":i:a,a=t.children,t=u(t,O),e=e||h.content,t=s({},t);return h.editMode&&(t["data-wurd-obj"]=e.id(r||n),t["data-wurd-obj-props"]=Array.isArray(o)?o.join(","):o),c.default.createElement(i,t,a)}h.setBlockHelpers({Text:function(t){return c.default.createElement(v,s({block:this},t))},Markdown:function(t){return c.default.createElement(y,s({block:this},t))},Image:function(t){return c.default.createElement(w,s({block:this},t))},List:function(t){return c.default.createElement(k,s({block:this},t))},Object:function(t){return c.default.createElement(j,s({block:this},t))}}),t.WurdImage=w,t.WurdList=k,t.WurdMarkdown=y,t.WurdObject=j,t.WurdText=v,t.default=h,Object.defineProperty(t,"__esModule",{value:!0})});
