!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("react")):"function"==typeof define&&define.amd?define(["exports","react"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).wurd={},t.React)}(this,(function(t,e){"use strict";function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var r=n(e);function o(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?o(Object(n),!0).forEach((function(e){u(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function c(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function s(t,e,n){return e&&c(t.prototype,e),n&&c(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function u(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function d(t,e){if(null==t)return{};var n,r,o=function(t,e){if(null==t)return{};var n,r,o={},i=Object.keys(t);for(r=0;r<i.length;r++)n=i[r],e.indexOf(n)>=0||(o[n]=t[n]);return o}(t,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(r=0;r<i.length;r++)n=i[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(o[n]=t[n])}return o}var l=function(){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};a(this,t),this.rawContent=n,this.storageKey=r.storageKey||"wurdContent",this.ttl=null!==(e=r.ttl)&&void 0!==e?e:36e5}return s(t,[{key:"get",value:function(t){return t?t.split(".").reduce((function(t,e){return t&&t[e]}),this.rawContent):this.rawContent}},{key:"load",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.lang,r=this.rawContent,o=this.storageKey,i=this.ttl;try{var a=JSON.parse(localStorage.getItem(o)),c=a&&a._wurd;return!a||!c||c.savedAt+i<Date.now()||(c.lang!==n||(delete a._wurd,Object.assign(r,a))),r}catch(t){return console.error("Wurd: error loading cache:",t),r}}},{key:"save",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.lang,r=this.rawContent,o=this.storageKey;Object.assign(r,t),localStorage.setItem(o,JSON.stringify(i(i({},r),{},{_wurd:{savedAt:Date.now(),lang:n}})))}},{key:"clear",value:function(){localStorage.removeItem(this.storageKey)}}]),t}(),f=function(){function t(e,n){var r=this;a(this,t),this.wurd=e,this.path=n,this._get=e.store.get.bind(e.store),Object.getOwnPropertyNames(Object.getPrototypeOf(this)).forEach((function(t){r[t]=r[t].bind(r)}))}return s(t,[{key:"id",value:function(t){return t?this.path?[this.path,t].join("."):t:this.path}},{key:"get",value:function(t){var e=this._get(this.id(t));if(void 0===e&&this.wurd.draft){var n=t.split(".")[0];this._get(n)||console.warn("Tried to access unloaded section: ".concat(n))}return e}},{key:"text",value:function(t,e){var n=this.get(t);return void 0===n?this.wurd.draft?"[".concat(t,"]"):"":"string"!=typeof n?(console.warn("Tried to get object as string: ".concat(t)),this.wurd.draft?"[".concat(t,"]"):""):(e&&(n=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"string"!=typeof t?t:t.replace(/{{([\w.-]+)}}/g,(function(t,n){return e[n]||""}))}(n,e)),n)}},{key:"markdown",value:function(t,e,n){var r=this.wurd.markdown,o=r.parse,i=r.parseInline,a=this.text(t,e);return null!=n&&n.inline&&i?i(a):o?o(a):a}},{key:"map",value:function(t,e){var n=this,r=this.get(t)||u({},Date.now(),{}),o=0;return Object.keys(r).sort().map((function(r){var i=o;o++;var a=[t,r].join("."),c=n.block(a);return e.call(void 0,c,i)}))}},{key:"block",value:function(e,n){var r=this.id(e),o=new t(this.wurd,r);return"function"==typeof n?n.call(void 0,o):o}},{key:"el",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=this.id(t),o=n.markdown?this.markdown(t,e):this.text(t,e),i=e||n.markdown?"data-wurd-md":"data-wurd";if(this.wurd.draft){var a=n.type||"span";return n.markdown&&(a="div"),"<".concat(a," ").concat(i,'="').concat(r,'">').concat(o,"</").concat(a,">")}return o}}]),t}(),h=function(){function t(e){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};a(this,t),this.widgetUrl="https://widget.wurd.io/widget.js",this.apiUrl="https://api.wurd.io",this.store=new l,this.content=new f(this,null);var o=Object.getOwnPropertyNames(Object.getPrototypeOf(this.content));o.forEach((function(t){n[t]=n.content[t].bind(n.content)})),this.connect(e,r)}return s(t,[{key:"connect",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};switch(this.app=t,this.draft=!1,this.editMode=!1,["draft","lang","markdown","debug","onLoad"].forEach((function(t){var r=n[t];void 0!==r&&(e[t]=r)})),n.editMode){case!0:this.startEditor();break;case"querystring":/[?&]edit(&|$)/.test(location.search)&&this.startEditor()}return n.rawContent&&this.store.save(n.rawContent,{lang:n.lang}),n.storageKey&&(this.store.storageKey=n.storageKey),n.ttl&&(this.store.ttl=n.ttl),n.blockHelpers&&this.setBlockHelpers(n.blockHelpers),this}},{key:"load",value:function(t){var e=this.app,n=this.store,r=this.lang,o=this.editMode,i=this.debug,a=this.onLoad,c=this.content;if(!e)return Promise.reject(new Error("Use wurd.connect(appName) before wurd.load()"));var s="string"==typeof t?t.split(","):t;if(o)return this._fetchSections(s).then((function(t){return n.save(t,{lang:r}),n.clear(),a&&a(c),c}));var u=n.load(s,{lang:r}),d=s.filter((function(t){return void 0===u[t]}));return i&&console.info("Wurd: from cache:",s.filter((function(t){return void 0!==u[t]}))),0===d.length?(a&&a(c),Promise.resolve(c)):this._fetchSections(d).then((function(t){return n.save(t,{lang:r}),a&&a(c),c}))}},{key:"_fetchSections",value:function(t){var e=this,n=this.app;this.debug&&console.info("Wurd: from server:",t);var r,o=["draft","lang"].reduce((function(t,n){return e[n]&&(t[n]=e[n]),t}),{}),i="".concat(this.apiUrl,"/apps/").concat(n,"/content/").concat(t,"?").concat((r=o,Object.keys(r).map((function(t){var e=r[t];return encodeURIComponent(t)+"="+encodeURIComponent(e)})).join("&")));return this._fetch(i).then((function(e){if(e.error)throw e.error.message?new Error(e.error.message):new Error("Error loading ".concat(t));return e}))}},{key:"_fetch",value:function(t){return fetch(t).then((function(e){if(!e.ok)throw new Error("Error loading ".concat(t,": ").concat(e.statusText));return e.json()}))}},{key:"startEditor",value:function(){var t=this.app,e=this.lang;this.editMode=!0,this.draft=!0;var n=document.createElement("script");n.src=this.widgetUrl,n.async=!0,n.setAttribute("data-app",t),e&&n.setAttribute("data-lang",e);var r=document.body.querySelector('script[src="'.concat(this.widgetUrl,'"]'));r&&document.body.removeChild(r),document.body.appendChild(n)}},{key:"setBlockHelpers",value:function(t){Object.assign(f.prototype,t)}}]),t}(),p=new h;p.Wurd=h;var v=["block","id","sid","type","component","vars"];function g(t){var e=t.block,n=t.id,o=t.sid,a=t.type,c=void 0===a?"span":a,s=t.component,u=void 0===s?c:s,l=t.vars,f=d(t,v),h=(e=e||p.content).text(n,l),g=i({},f);p.editMode&&(g[l?"data-wurd-md":"data-wurd"]=e.id(o||n));return r.default.createElement(u,g,h)}var y=["block","id","sid","type","component","vars","inline"];function b(t){var e=t.block,n=t.id,o=t.sid,a=t.type,c=void 0===a?"div":a,s=t.component,u=void 0===s?c:s,l=t.vars,f=t.inline,h=d(t,y),v=(e=e||p.content).markdown(n,l,{inline:f}),g=i(i({},h),{},{dangerouslySetInnerHTML:{__html:v}});return p.editMode&&(g["data-wurd-md"]=e.id(o||n)),r.default.createElement(u,g)}var w=["block","id","sid"];function m(t){var e=t.block,n=t.id,o=t.sid,a=d(t,w),c=(e=e||p.content).text(n),s=i(i({},a),{},{src:c});return p.editMode&&(s["data-wurd-img"]=e.id(o||n)),r.default.createElement("img",s)}var k=["block","id","children","type","component","keys"];function O(t){var e=t.block,n=t.id,o=t.children,a=t.type,c=void 0===a?"ul":a,s=t.component,u=void 0===s?c:s,l=t.keys,f=void 0===l?"title":l,h=d(t,k);e=e||p.content;var v=i({},h);return p.editMode&&(v["data-wurd-list"]=e.id(n),v["data-wurd-list-props"]=f),r.default.createElement(u,v,e.map(n,(function(t,e){return o(t,e)})))}var j=["block","id","sid","keys","type","component","children"];function E(t){var e=t.block,n=t.id,o=t.sid,a=t.keys,c=t.type,s=void 0===c?"span":c,u=t.component,l=void 0===u?s:u,f=t.children,h=d(t,j);e=e||p.content;var v=i({},h);return p.editMode&&(v["data-wurd-obj"]=e.id(o||n),v["data-wurd-obj-props"]=Array.isArray(a)?a.join(","):a),r.default.createElement(l,v,f)}p.setBlockHelpers({Text:function(t){return r.default.createElement(g,i({block:this},t))},Markdown:function(t){return r.default.createElement(b,i({block:this},t))},Image:function(t){return r.default.createElement(m,i({block:this},t))},List:function(t){return r.default.createElement(O,i({block:this},t))},Object:function(t){return r.default.createElement(E,i({block:this},t))}}),t.WurdImage=m,t.WurdList=O,t.WurdMarkdown=b,t.WurdObject=E,t.WurdText=g,t.default=p,Object.defineProperty(t,"__esModule",{value:!0})}));
